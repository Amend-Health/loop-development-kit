# Loop Development Kit (LDK) for Go

The LDK is a plugin system for Sidekick. The LDK is built with [go-plugin](https://github.com/hashicorp/go-plugin), a HashiCorp plugin system used in several of their projects.

Plugins developed with this library are executed by Sidekick as separate processes. This ensures that crashes or instability in the plugin will not destabilize the Sidekick process.

Communication between Sidekick and the plugin is first initialized over stdio and then performed using [GRPC](https://grpc.io/). On mac and linux the GRPC communication is sent over unix domain socket and on windows over local TCP socket.

In order for Sidekick to use a plugin, it must be compiled. Sidekick does not compile or interpret source code at runtime. A consequence of this is that plugins will need to be compiled for each operating system that they want to support.

## Installation

```shell
go get -u github.com/open-olive/loop-development-kit-go
```

## Usage
Full documentation available on [GoDoc](https://godoc.org/github.com/open-olive/loop-development-kit-go).

### Controllers
This LDK can be used to write controllers for Sidekick. More detail about controllers is available [here](docs/controller.md).

* [Basic Controller Example](https://github.com/open-olive/sidekick-controller-examplego) - Recommend using as a starting point for new Controllers.

### Sensors
This LDK can be used to write sensors for Sidekick. More detail about sensors is available [here](docs/sensor.md).

* [Basic Sensor Example](https://github.com/open-olive/sidekick-sensor-examplego) - Recommend using as a starting point for new Sensors.

## Development

### protoc
The LDK utilizes `protoc` to create the `protobuf` that defines the contract that is utilized by GRPC.

* Install protobuf with Homebrew `brew link protobuf`
* Make your changes to `proto/ldk.proto`
* Then generate the new protobuf file with `make proto/ldk.pb.go`

Since `proto/ldk.pb.go` is auto-generated, do not edit this file directly.

### Running Locally

#### Local Plugin Command (Recommended)

Sidekick lets you add a local command as Local Plugins:

1. Open Sidekick.
2. Open the Loop Library:
    1. Click the Hamburger icon.
    2. Click Loop Library.
3. Click the Install Local Plugin button:
4. Select whether it's a Controller or Sensor.
5. Select the working directory for the command.
6. Enter the command to be executed, including any arguments.
7. Click Install.

The command will be installed as a plugin. If you need to change the command or its arguments you'll need remove it and then add the new commands. If you are developing locally, it can be helpful to give it the `go run` command, as this will remove the need to recompile each time to check your changes:

```sh
go run main.go
```

Be sure that when you selected the `Directory` in `Step 5` that it is the root of your project that has the `main.go` file located in it.

### Troubleshooting and Debugging

Sidekick logs are available in the following directories for your OS:

```shell
~/Library/Logs/Sidekick  # MacOS
/var/log/Sidekick        # Linux
%AppData%\Sidekick\Logs\ # Windows
```

#### Tailing Logs

It can be useful to tail the log as you develop to see any errors, warnings, or info messages.  To do so, you can issue any of the following commands:

##### Linux

```sh
tail -f /var/log/Sidekick/Sidekick-2020.08.12-1dcc37a.log
```

##### Mac

```sh
tail -f ~/Library/Logs/Sidekick/Sidekick-2020.08.12-1dcc37a.log
```

##### Windows

From `Powershell` (not a cmd shell):

```powershell
Get-Content $env:AppData\Sidekick\Logs\Sidekick-2020.08.12-1dcc37a.log â€“Wait
```

Note: File names may differ from the example above.

### Configuration

#### `storage.json`

Each storage key you access must be specified in the `storage.json` file.

```json
{
  "storage-key": {
    "name": "Storage Key Name",
    "description": "What you're containing in this key"
  },
  "storage-key2": {
    "name": "Storage Key 2",
    "description": "What you're containing in this key"
  }
}
```
